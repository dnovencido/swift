<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SWIFT 2.0 - User & Farm Management</title>
    <link rel="icon" type="image/png" href="../img/SWIFT-LOGO-MONOGRAM.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link rel="stylesheet" href="../css/style.css?v=1759866206" />
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-top">
            <div class="logo">
                <img src="../img/SWIFT-LOGO-TITLE.png" alt="SWIFT" style="height: 120px; width: auto;">
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
                <a href="user-farmanagement.html" class="nav-item active"><i class="fas fa-users-cog"></i><span>User & Farm Management</span></a>
                <a href="activity_log.html" class="nav-item"><i class="fas fa-history"></i><span>Activity Log</span></a>
            </div>
        </div>
        <div class="sidebar-bottom">
            <div class="nav-menu">
                <a href="../login.html" class="nav-item" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i><span>Logout</span></a>
            </div>
        </div>
    </div>
    <div class="main-content">
        <div class="header" style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
            <div class="welcome-section"><p class="greeting" id="greeting">&nbsp;</p><h1 class="welcome-title">User & Farm Management</h1></div>
            <div style="display:flex; gap:8px; align-items:center;">
                <input id="globalSearch" type="text" placeholder="Search user by username..." style="padding:10px; border:1px solid var(--gray-medium); border-radius:8px; width:280px;" />
                <button id="searchBtn" class="control-btn">Search</button>
            </div>
        </div>
        <div class="control-card" style="margin-top:16px;">
            <h2 class="section-title">Personal Information</h2>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px;">
                <div><label>First Name</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="firstName"></div>
                <div><label>Last Name</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="lastName"></div>
                <div><label>Middle Name</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="middleName"></div>
                <div><label>Mobile Number</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="mobile"></div>
                <div><label>Email Address</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="email" id="email"></div>
                <div><label>Username</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="username"></div>
                <div><label>Password</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="password" id="password"></div>
            </div>
            <h3 style="margin-top:16px;">Address</h3>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px;">
                <div><label>Street Address/Purok/Sitio</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="addrStreet"></div>
                <div><label>Barangay (Village)</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="addrBarangay"></div>
                <div><label>Municipality/City</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="addrCity"></div>
                <div><label>Province</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="addrProvince"></div>
                <div><label>Postal Code (optional)</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="addrPostal"></div>
            </div>
            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="control-btn" id="userAddBtn" style="min-width:140px;">Add</button>
                <button class="control-btn" id="userClearBtn" style="background:var(--gray-200); min-width:140px;">Clear</button>
                <button class="control-btn" id="userUpdateBtn" style="background:var(--gray-300); min-width:140px;">Update</button>
                <button class="control-btn" id="userDeleteBtn" style="background:var(--danger); min-width:140px;">Delete</button>
            </div>
        </div>
        <div class="control-card" style="margin-top:16px;">
            <h2 class="section-title">Farm Information</h2>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px;">
                <div><label>Farm Name</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="farmName"></div>
            </div>
            <h3 style="margin-top:16px;">Farm Address</h3>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px;">
                <div><label>Street Address/Purok/Sitio</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="farmStreet"></div>
                <div><label>Barangay (Village)</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="farmBarangay"></div>
                <div><label>Municipality/City</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="farmCity"></div>
                <div><label>Province</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="farmProvince"></div>
                <div><label>Postal Code (optional)</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="farmPostal"></div>
            </div>
            <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <label for="farmSelect" style="font-weight:600;">Select Farm:</label>
                <select id="farmSelect" style="padding:10px; border:1px solid var(--gray-medium); border-radius:8px; min-width:220px;">
                    <option value="">-- No farms --</option>
                </select>
            </div>
            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="control-btn" id="btnAddFarm" style="min-width:140px;">Add</button>
                <button class="control-btn" id="clearBtn" style="background:var(--gray-200); min-width:140px;">Clear</button>
                <button class="control-btn" id="btnUpdateFarm" style="background:var(--gray-300); min-width:140px;">Update</button>
                <button class="control-btn" id="btnDelFarm" style="background:var(--danger); min-width:140px;">Delete</button>
            </div>
        </div>
        <div class="control-card" style="margin-top:16px;">
            <h2 class="section-title">Device Management & Assignment</h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.9em;">
                Register new devices and assign them to users, or manage existing device assignments. 
                This handles both device registration and user assignment in one place.
            </p>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px;">
                <div><label>Device Name</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="deviceName" placeholder="e.g., SWIFT Water Sprinkler Device"></div>
                <div><label>IP Address</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="deviceIP" placeholder="e.g., 192.168.1.11"></div>
                <div><label>Device Code (Optional)</label><input style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;" type="text" id="deviceCode" placeholder="e.g., SWIFT001"></div>
                <div><label>Device Type</label>
                    <select id="deviceType" style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;">
                        <option value="sensor">Sensor</option>
                        <option value="controller">Controller</option>
                    </select>
                </div>
            </div>
            <div style="margin-top:16px; display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px;">
                <div>
                    <label for="deviceUserSelect" style="font-weight:600;">Assign to User:</label>
                    <select id="deviceUserSelect" style="width:100%;padding:10px;border:1px solid var(--gray-medium);border-radius:8px;">
                        <option value="">-- Select User --</option>
                    </select>
                </div>
                <div>
                    <label for="deviceFarmSelect" style="font-weight:600;">Assign to Farm:</label>
                    <select id="deviceFarmSelect" style="width:100%; padding:10px; border:1px solid var(--gray-medium); border-radius:8px;">
                        <option value="">-- Select Farm --</option>
                    </select>
                </div>
            </div>
            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="control-btn" id="btnAssignDevice" style="min-width:140px;">Register & Assign</button>
                <button class="control-btn" id="btnClearDevice" style="background:var(--gray-200); min-width:140px;">Clear</button>
                <button class="control-btn" id="btnUpdateDevice" style="background:var(--gray-300); min-width:140px;">Update</button>
                <button class="control-btn" id="btnDeleteDevice" style="background:var(--danger); min-width:140px;">Delete</button>
                <button class="control-btn" id="btnTestDropdowns" style="background:var(--primary); min-width:140px;">Test Dropdowns</button>
            </div>
            <div style="margin-top:16px;">
                <h3>Assigned Devices</h3>
                <div id="deviceList" style="max-height:300px; overflow-y:auto; border:1px solid var(--gray-medium); border-radius:8px; padding:10px;">
                    <p style="text-align:center; color:var(--gray-500);">No devices assigned yet</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal System -->
    <div id="modalOverlay" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title-section">
                    <i id="modalIcon" class="fas fa-info-circle"></i>
                    <h3 id="modalTitle">Alert</h3>
                </div>
                <button id="modalClose" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Message</p>
            </div>
            <div class="modal-footer">
                <button id="modalConfirm" class="modal-btn modal-btn-primary">OK</button>
                <button id="modalCancel" class="modal-btn modal-btn-secondary" style="display: none;">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const u = JSON.parse(localStorage.getItem('swift_user')||'null');
                console.log('Authentication check - User data:', u);
                if (!u) { 
                    console.log('No user data found, redirecting to login');
                    window.location.href = '../index.html'; 
                    return; 
                }
                if ((u.role||'').toLowerCase() !== 'super_user') { 
                    console.log('User role is not super_user, redirecting to user page');
                    window.location.href = '../user/dashboard.html'; 
                    return; 
                }
                console.log('Authentication successful, user is super_user');
            } catch(e){ 
                console.error('Authentication error:', e);
                window.location.href='../login.html'; 
                return; 
            }
            const hour=new Date().getHours(); const s=hour<12?'Good Morning':(hour<17?'Good Afternoon':'Good Evening'); let n='Admin'; try{const st=localStorage.getItem('swift_user'); if(st){const p=JSON.parse(st); n=p.username||n;}}catch(e){}; document.getElementById('greeting').textContent=`${s}, ${n}!`;
            document.getElementById('logoutBtn').addEventListener('click', (e)=>{ e.preventDefault(); fetch('../php/admin_auth.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'logout'})}).finally(()=>{ try{localStorage.removeItem('swift_user');}catch(e){} window.location.href='../login.html'; });});
            
            // Modal System Functions
            function showModal(title, message, type = 'info', showCancel = false) {
                return new Promise((resolve) => {
                    const modal = document.getElementById('modalOverlay');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalMessage = document.getElementById('modalMessage');
                    const modalIcon = document.getElementById('modalIcon');
                    const modalConfirm = document.getElementById('modalConfirm');
                    const modalCancel = document.getElementById('modalCancel');
                    const modalClose = document.getElementById('modalClose');
                    
                    // Set content
                    modalTitle.textContent = title;
                    modalMessage.textContent = message;
                    
                    // Set icon based on type
                    const iconMap = {
                        'info': 'fas fa-info-circle',
                        'success': 'fas fa-check-circle',
                        'error': 'fas fa-exclamation-triangle',
                        'warning': 'fas fa-exclamation-circle',
                        'confirm': 'fas fa-question-circle',
                        'delete': 'fas fa-trash-alt'
                    };
                    
                    modalIcon.className = iconMap[type] || iconMap['info'];
                    
                    // Set icon color based on type
                    const colorMap = {
                        'info': '#1877f2',
                        'success': '#42b883',
                        'error': '#f02849',
                        'warning': '#f7b928',
                        'confirm': '#17a2b8',
                        'delete': '#f02849'
                    };
                    
                    modalIcon.style.color = colorMap[type] || colorMap['info'];
                    
                    // Show/hide cancel button
                    modalCancel.style.display = showCancel ? 'inline-block' : 'none';
                    
                    // Set button text based on type
                    if (type === 'success') {
                        modalConfirm.textContent = 'OK';
                        modalConfirm.className = 'modal-btn modal-btn-primary';
                    } else if (type === 'error') {
                        modalConfirm.textContent = 'OK';
                        modalConfirm.className = 'modal-btn modal-btn-primary';
                    } else if (type === 'confirm') {
                        modalConfirm.textContent = 'Confirm';
                        modalConfirm.className = 'modal-btn modal-btn-primary';
                        modalCancel.textContent = 'Cancel';
                    } else if (type === 'delete') {
                        modalConfirm.textContent = 'Delete';
                        modalConfirm.className = 'modal-btn modal-btn-danger';
                        modalCancel.textContent = 'Cancel';
                    } else {
                        modalConfirm.textContent = 'OK';
                        modalConfirm.className = 'modal-btn modal-btn-primary';
                    }
                    
                    // Show modal
                    modal.style.display = 'flex';
                    
                    // Event handlers
                    const handleConfirm = () => {
                        modal.style.display = 'none';
                        resolve(true);
                        cleanup();
                    };
                    
                    const handleCancel = () => {
                        modal.style.display = 'none';
                        resolve(false);
                        cleanup();
                    };
                    
                    const handleClose = () => {
                        modal.style.display = 'none';
                        resolve(false);
                        cleanup();
                    };
                    
                    const cleanup = () => {
                        modalConfirm.removeEventListener('click', handleConfirm);
                        modalCancel.removeEventListener('click', handleCancel);
                        modalClose.removeEventListener('click', handleClose);
                        modal.removeEventListener('click', handleOverlayClick);
                    };
                    
                    const handleOverlayClick = (e) => {
                        if (e.target === modal) {
                            handleClose();
                        }
                    };
                    
                    // Add event listeners
                    modalConfirm.addEventListener('click', handleConfirm);
                    modalCancel.addEventListener('click', handleCancel);
                    modalClose.addEventListener('click', handleClose);
                    modal.addEventListener('click', handleOverlayClick);
                    
                    // Focus on confirm button
                    setTimeout(() => modalConfirm.focus(), 100);
                });
            }
            
            // Replace alert function
            window.alert = (message) => showModal('Alert', message, 'info');
            
            // Replace confirm function
            window.confirm = (message) => showModal('Confirm', message, 'confirm', true);
            function clearPersonal(){ document.getElementById('firstName').value=''; document.getElementById('lastName').value=''; document.getElementById('middleName').value=''; document.getElementById('mobile').value=''; document.getElementById('email').value=''; document.getElementById('addrStreet').value=''; document.getElementById('addrBarangay').value=''; document.getElementById('addrCity').value=''; document.getElementById('addrProvince').value=''; document.getElementById('addrPostal').value=''; document.getElementById('username').value=''; document.getElementById('password').value=''; }
            document.getElementById('userClearBtn').addEventListener('click', clearPersonal);
            document.getElementById('userAddBtn').addEventListener('click', async ()=>{ try{ selectedUser=null; await upsertUserAndMaybeGetId(true); farmSelect.innerHTML="<option value=''>-- No farms --</option>"; selectedFarm=null; clearFarm(); showModal('Success', 'User added successfully!', 'success'); }catch(e){ showModal('Error', e.message||'Add failed', 'error'); } });
            document.getElementById('userUpdateBtn').addEventListener('click', async ()=>{ try{ if(!selectedUser){ showModal('Warning', 'Search and load a user first', 'warning'); return; } await upsertUserAndMaybeGetId(false); showModal('Success', 'User updated successfully!', 'success'); }catch(e){ showModal('Error', e.message||'Update failed', 'error'); } });
            document.getElementById('userDeleteBtn').addEventListener('click', async ()=>{ try{ if(!selectedUser||!selectedUser.id){ showModal('Warning', 'Search and load a user first', 'warning'); return; } if(!await showModal('Delete User', 'Are you sure you want to delete this user and all related data?', 'delete', true)) return; const res=await fetch('../php/admin_users.php',{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:selectedUser.id})}); const d=await res.json(); if(!d.success) throw new Error(d.message||'Delete failed'); clearPersonal(); farmSelect.innerHTML="<option value=''>-- No farms --</option>"; selectedUser=null; selectedFarm=null; showModal('Success', 'User deleted successfully!', 'success'); }catch(e){ showModal('Error', e.message||'Delete failed', 'error'); } });
            function clearFarm(){ document.getElementById('farmName').value=''; document.getElementById('farmStreet').value=''; document.getElementById('farmBarangay').value=''; document.getElementById('farmCity').value=''; document.getElementById('farmProvince').value=''; document.getElementById('farmPostal').value=''; selectedFarm=null; }
            document.getElementById('clearBtn').addEventListener('click', ()=>{ clearFarm(); farmSelect.value=''; });
            document.getElementById('btnAddFarm').addEventListener('click', async ()=>{
                try{
                    if(!selectedUser||!selectedUser.id){ showModal('Warning', 'Search and load a user first', 'warning'); return; }
                    const farm_name=document.getElementById('farmName').value.trim();
                    if(!farm_name){ showModal('Warning', 'Enter farm name', 'warning'); return; }
                    const street=document.getElementById('farmStreet').value.trim();
                    const barangay=document.getElementById('farmBarangay').value.trim();
                    const city=document.getElementById('farmCity').value.trim();
                    const province=document.getElementById('farmProvince').value.trim();
                    const postal=document.getElementById('farmPostal').value.trim();
                    const res = await fetch('../php/admin_farms.php',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id:selectedUser.id, farm_name, street, barangay, city, province, postal }) });
                    const d = await res.json(); if(!d.success) throw new Error(d.message||'Add failed');
                    selectedFarm = { id: d.id, name: farm_name, street, barangay, city, province, postal };
                    await loadFarmsByUser(selectedUser.id, d.id);
                    showModal('Success', 'Added', 'success');
                } catch(e){ showModal('Error', e.message||'Add failed', 'error'); }
            });
            async function upsertUserAndMaybeGetId(includePassword){
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const payload = {
                    username,
                    role: (selectedUser&&selectedUser.role)||'user',
                    first_name: document.getElementById('firstName').value.trim(),
                    last_name: document.getElementById('lastName').value.trim(),
                    middle_name: document.getElementById('middleName').value.trim(),
                    mobile: document.getElementById('mobile').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    addr_street: document.getElementById('addrStreet').value.trim(),
                    addr_barangay: document.getElementById('addrBarangay').value.trim(),
                    addr_city: document.getElementById('addrCity').value.trim(),
                    addr_province: document.getElementById('addrProvince').value.trim(),
                    addr_postal: document.getElementById('addrPostal').value.trim()
                };
                if (!username) throw new Error('Username is required');
                if (selectedUser && selectedUser.id){
                    const body = { id: selectedUser.id, ...payload };
                    if (includePassword && password) body.password = password;
                    const res = await fetch('../php/admin_users.php',{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
                    const d = await res.json(); if(!d.success) throw new Error(d.message||'User update failed');
                    return selectedUser.id;
                } else {
                    if (!password) throw new Error('Password is required to create a new user');
                    const res = await fetch('../php/admin_users.php',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ...payload, password })});
                    const d = await res.json(); if(!d.success) throw new Error(d.message||'User create failed');
                    const newId = d.id; selectedUser = { id:newId, username: payload.username, role: payload.role };
                    return newId;
                }
            }
            async function upsertFarm(userId){
                const farm_name=document.getElementById('farmName').value.trim();
                const street=document.getElementById('farmStreet').value.trim();
                const barangay=document.getElementById('farmBarangay').value.trim();
                const city=document.getElementById('farmCity').value.trim();
                const province=document.getElementById('farmProvince').value.trim();
                const postal=document.getElementById('farmPostal').value.trim();
                if (!farm_name) return false;
                if (!selectedFarm) return false;
                const res = await fetch('../php/admin_farms.php',{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id:selectedFarm.id, user_id:userId, farm_name, street, barangay, city, province, postal }) });
                const d = await res.json(); if(!d.success) throw new Error(d.message||'Update failed');
                await loadFarmsByUser(userId, selectedFarm.id);
                return true;
            }
            let selectedUser = null; let selectedFarm = null; let selectedDevice = null;
            function searchUser(){ 
                const q=document.getElementById('globalSearch').value.trim(); 
                if(!q){ showModal('Warning', 'Enter username', 'warning'); return; } 
                console.log('Searching for user:', q);
                fetch(`../php/admin_users.php?q=${encodeURIComponent(q)}`)
                    .then(r=>r.json())
                    .then(d=>{ 
                        console.log('User search result:', d);
                        const rows=(d&&d.success&&d.data)||[]; 
                        if(rows.length===0){ showModal('Warning', 'User not found', 'warning'); return; } 
                        const u=rows[0]; 
                        selectedUser = { id:u.id, username:u.username, role:u.role };
                        console.log('Selected user:', selectedUser);
                        document.getElementById('firstName').value = u.first_name||'';
                        document.getElementById('lastName').value = u.last_name||'';
                        document.getElementById('middleName').value = u.middle_name||'';
                        document.getElementById('mobile').value = u.mobile||'';
                        document.getElementById('email').value = u.email||'';
                        document.getElementById('addrStreet').value = u.addr_street||'';
                        document.getElementById('addrBarangay').value = u.addr_barangay||'';
                        document.getElementById('addrCity').value = u.addr_city||'';
                        document.getElementById('addrProvince').value = u.addr_province||'';
                        document.getElementById('addrPostal').value = u.addr_postal||'';
                        document.getElementById('username').value = u.username;
                        document.getElementById('password').value = '';
                        console.log('Loading farms for user ID:', u.id);
                        loadFarmsByUser(u.id);
                        loadDevicesByUser(u.id);
                    })
                    .catch(e => {
                        console.error('Search error:', e);
                        showModal('Error', 'Search error', 'error');
                    }); 
            }
            document.getElementById('searchBtn').addEventListener('click', searchUser);
            document.getElementById('globalSearch').addEventListener('keydown',(e)=>{ if(e.key==='Enter') searchUser(); });
            const farmSelect = document.getElementById('farmSelect');
            function loadFarmsByUser(userId, preferredId) {
                console.log('loadFarmsByUser called with userId:', userId, 'preferredId:', preferredId);
                fetch(`../php/admin_farms.php?user_id=${userId}`)
                    .then(r => r.json())
                    .then(d => {
                        console.log('Farm API response:', d);
                        const rows = (d && d.success && d.data) || [];
                        console.log('Farm rows:', rows);
                        if (rows.length) {
                            farmSelect.innerHTML = rows.map(f => 
                                `<option value='${f.id}' data-name='${f.farm_name}' data-street='${f.street||''}' data-barangay='${f.barangay||''}' data-city='${f.city||''}' data-province='${f.province||''}' data-postal='${f.postal||''}'>${f.farm_name}</option>`
                            ).join('');
                            const pickId = preferredId ? String(preferredId) : String(rows[0].id);
                            farmSelect.value = pickId;
                            const sel = rows.find(r => String(r.id) === pickId) || rows[0];
                            selectedFarm = { 
                                id: sel.id, 
                                name: sel.farm_name, 
                                street: sel.street || '', 
                                barangay: sel.barangay || '', 
                                city: sel.city || '', 
                                province: sel.province || '', 
                                postal: sel.postal || '' 
                            };
                            console.log('Selected farm:', selectedFarm);
                            document.getElementById('farmName').value = selectedFarm.name;
                            document.getElementById('farmStreet').value = selectedFarm.street;
                            document.getElementById('farmBarangay').value = selectedFarm.barangay;
                            document.getElementById('farmCity').value = selectedFarm.city;
                            document.getElementById('farmProvince').value = selectedFarm.province;
                            document.getElementById('farmPostal').value = selectedFarm.postal;
                            console.log('Farm fields populated:', {
                                farmName: document.getElementById('farmName').value,
                                farmCity: document.getElementById('farmCity').value,
                                farmProvince: document.getElementById('farmProvince').value
                            });
                        } else {
                            console.log('No farms found for user');
                            farmSelect.innerHTML = "<option value=''>-- No farms --</option>";
                            selectedFarm = null;
                            document.getElementById('farmName').value = '';
                            document.getElementById('farmStreet').value = '';
                            document.getElementById('farmBarangay').value = '';
                            document.getElementById('farmCity').value = '';
                            document.getElementById('farmProvince').value = '';
                            document.getElementById('farmPostal').value = '';
                        }
                    })
                    .catch(e => {
                        console.error('Farm loading error:', e);
                        farmSelect.innerHTML = "<option value=''>-- Error --</option>";
                    });
            }
            farmSelect.addEventListener('change', () => {
                const opt = farmSelect.selectedOptions[0];
                if (!opt || !opt.value) {
                    selectedFarm = null;
                    return;
                }
                selectedFarm = { 
                    id: parseInt(opt.value, 10), 
                    name: opt.getAttribute('data-name'), 
                    street: opt.getAttribute('data-street'), 
                    barangay: opt.getAttribute('data-barangay'), 
                    city: opt.getAttribute('data-city'), 
                    province: opt.getAttribute('data-province'), 
                    postal: opt.getAttribute('data-postal') 
                };
                document.getElementById('farmName').value = selectedFarm.name;
                document.getElementById('farmStreet').value = selectedFarm.street;
                document.getElementById('farmBarangay').value = selectedFarm.barangay;
                document.getElementById('farmCity').value = selectedFarm.city;
                document.getElementById('farmProvince').value = selectedFarm.province;
                document.getElementById('farmPostal').value = selectedFarm.postal;
            });
            document.getElementById('btnUpdateFarm').addEventListener('click', async ()=>{
                try{
                    if(!selectedUser||!selectedUser.id){ showModal('Warning', 'Search and load a user first', 'warning'); return; }
                    await upsertFarm(selectedUser.id);
                    showModal('Success', 'Updated', 'success');
                } catch(e){ showModal('Error', e.message||'Update failed', 'error'); }
            });
            document.getElementById('btnDelFarm').addEventListener('click', async ()=>{
                try{
                    if(!selectedUser||!selectedUser.id){ showModal('Warning', 'Search and load a user first', 'warning'); return; }
                    if(!selectedFarm){ showModal('Warning', 'Select a farm from the list', 'warning'); return; }
                    if(!confirm('Delete this farm?')) return;
                    const res = await fetch('../php/admin_farms.php',{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:selectedFarm.id})});
                    const d = await res.json(); if(!d.success) throw new Error(d.message||'Delete failed');
                    await loadFarmsByUser(selectedUser.id); clearFarm();
                    showModal('Success', 'Deleted', 'success');
                } catch(e){ showModal('Error', e.message||'Delete failed', 'error'); }
            });
            
            // Device Assignment Functions
            function clearDevice() {
                document.getElementById('deviceName').value = '';
                document.getElementById('deviceIP').value = '';
                document.getElementById('deviceCode').value = '';
                document.getElementById('deviceType').value = 'sensor';
                document.getElementById('deviceUserSelect').value = '';
                document.getElementById('deviceFarmSelect').value = '';
                selectedDevice = null;
            }
            
            async function loadUsersForDeviceAssignment() {
                try {
                    console.log('Loading users for device assignment...');
                    const response = await fetch('../php/admin_users.php');
                    console.log('Users response:', response);
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Users data:', data);
                    
                    const userSelect = document.getElementById('deviceUserSelect');
                    if (!userSelect) {
                        console.error('deviceUserSelect element not found!');
                        return;
                    }
                    
                    userSelect.innerHTML = '<option value="">-- Select User --</option>';
                    
                    if (data && data.success && data.data) {
                        console.log('Found', data.data.length, 'users');
                        data.data.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.username} (${user.first_name || ''} ${user.last_name || ''})`.trim();
                            userSelect.appendChild(option);
                            console.log('Added user option:', option.textContent);
                        });
                    } else {
                        console.log('No users found or API error:', data);
                        console.log('Data structure:', JSON.stringify(data, null, 2));
                    }
                } catch (error) {
                    console.error('Error loading users:', error);
                    console.error('Error details:', error.message);
                }
            }
            
            async function loadFarmsForDeviceAssignment(userId) {
                if (!userId) {
                    document.getElementById('deviceFarmSelect').innerHTML = '<option value="">-- Select Farm --</option>';
                    return;
                }
                
                try {
                    console.log('Loading farms for user:', userId);
                    const response = await fetch(`../php/admin_farms.php?user_id=${userId}`);
                    console.log('Farms response:', response);
                    console.log('Farms response status:', response.status);
                    console.log('Farms response ok:', response.ok);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Farms data:', data);
                    
                    const farmSelect = document.getElementById('deviceFarmSelect');
                    if (!farmSelect) {
                        console.error('deviceFarmSelect element not found!');
                        return;
                    }
                    
                    farmSelect.innerHTML = '<option value="">-- Select Farm --</option>';
                    
                    if (data && data.success && data.data) {
                        console.log('Found', data.data.length, 'farms');
                        data.data.forEach(farm => {
                            const option = document.createElement('option');
                            option.value = farm.id;
                            option.textContent = farm.farm_name;
                            farmSelect.appendChild(option);
                            console.log('Added farm option:', option.textContent);
                        });
                    } else {
                        console.log('No farms found or API error:', data);
                        console.log('Farms data structure:', JSON.stringify(data, null, 2));
                    }
                } catch (error) {
                    console.error('Error loading farms:', error);
                    console.error('Farms error details:', error.message);
                }
            }
            
            function loadDevicesByUser(userId) {
                if (!userId) {
                    document.getElementById('deviceList').innerHTML = '<p style="text-align:center; color:var(--gray-500);">Search and select a user first</p>';
                    return;
                }
                
                fetch(`../php/admin_devices.php?user_id=${userId}`)
                    .then(r => r.json())
                    .then(d => {
                        const devices = (d && d.success && d.data) || [];
                        const deviceList = document.getElementById('deviceList');
                        
                        if (devices.length === 0) {
                            deviceList.innerHTML = '<p style="text-align:center; color:var(--gray-500);">No devices assigned to this user</p>';
                            return;
                        }
                        
                        deviceList.innerHTML = devices.map(device => `
                            <div style="border:1px solid var(--gray-300); border-radius:8px; padding:12px; margin-bottom:8px; cursor:pointer;" 
                                 onclick="selectDevice(${device.id}, '${device.device_name}', '${device.ip_address}', '${device.device_code || ''}', '${device.device_type}', ${device.farm_id || 'null'})"
                                 style="background:${selectedDevice && selectedDevice.id === device.id ? 'var(--primary-light)' : 'white'};">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <strong>${device.device_name}</strong>
                                        <div style="font-size:0.9em; color:var(--gray-600);">
                                            IP: ${device.ip_address} | Type: ${device.device_type} | Status: ${device.status}
                                        </div>
                                        <div style="font-size:0.8em; color:var(--gray-500);">
                                            Farm: ${device.farm_name || 'Not assigned'} | Last seen: ${device.last_seen || 'Never'}
                                        </div>
                                    </div>
                                    <div style="font-size:0.8em; color:var(--gray-500);">
                                        ${device.device_code ? 'Code: ' + device.device_code : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    })
                    .catch(e => {
                        console.error('Device loading error:', e);
                        document.getElementById('deviceList').innerHTML = '<p style="text-align:center; color:var(--danger);">Error loading devices</p>';
                    });
            }
            
            function selectDevice(id, name, ip, code, type, farmId) {
                selectedDevice = { id, name, ip, code, type, farmId };
                document.getElementById('deviceName').value = name;
                document.getElementById('deviceIP').value = ip;
                document.getElementById('deviceCode').value = code;
                document.getElementById('deviceType').value = type;
                document.getElementById('deviceFarmSelect').value = farmId || '';
                
                // Refresh device list to show selection
                if (selectedUser) {
                    loadDevicesByUser(selectedUser.id);
                }
            }
            
            // Device Assignment Event Listeners
            document.getElementById('deviceUserSelect').addEventListener('change', (e) => {
                const userId = e.target.value;
                loadFarmsForDeviceAssignment(userId);
            });
            
            document.getElementById('btnClearDevice').addEventListener('click', () => {
                clearDevice();
                if (selectedUser) {
                    loadDevicesByUser(selectedUser.id);
                }
            });
            
            document.getElementById('btnAssignDevice').addEventListener('click', async () => {
                try {
                    const userId = document.getElementById('deviceUserSelect').value;
                    if (!userId) {
                        showModal('Warning', 'Please select a user first', 'warning');
                        return;
                    }
                    
                    const deviceName = document.getElementById('deviceName').value.trim();
                    const deviceIP = document.getElementById('deviceIP').value.trim();
                    const deviceCode = document.getElementById('deviceCode').value.trim();
                    const deviceType = document.getElementById('deviceType').value;
                    const farmId = document.getElementById('deviceFarmSelect').value || null;
                    
                    if (!deviceName) {
                        showModal('Warning', 'Device name is required', 'warning');
                        return;
                    }
                    if (!deviceIP) {
                        showModal('Warning', 'IP address is required', 'warning');
                        return;
                    }
                    
                    const payload = {
                        device_name: deviceName,
                        device_code: deviceCode,
                        ip_address: deviceIP,
                        device_type: deviceType,
                        user_id: userId,
                        farm_id: farmId
                    };
                    
                    const res = await fetch('../php/admin_devices.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const d = await res.json();
                    if (!d.success) throw new Error(d.message || 'Assignment failed');
                    
                    showModal('Success', 'Device registered and assigned successfully', 'success');
                    clearDevice();
                    loadUsersForDeviceAssignment(); // Refresh user dropdown
                    
                } catch (e) {
                    showModal('Error', e.message || 'Registration and assignment failed', 'error');
                }
            });
            
            document.getElementById('btnUpdateDevice').addEventListener('click', async () => {
                try {
                    if (!selectedDevice || !selectedDevice.id) {
                        showModal('Warning', 'Select a device to update', 'warning');
                        return;
                    }
                    
                    if (!selectedUser || !selectedUser.id) {
                        showModal('Warning', 'Search and select a user first', 'warning');
                        return;
                    }
                    
                    const deviceName = document.getElementById('deviceName').value.trim();
                    const deviceIP = document.getElementById('deviceIP').value.trim();
                    const deviceCode = document.getElementById('deviceCode').value.trim();
                    const deviceType = document.getElementById('deviceType').value;
                    const farmId = document.getElementById('deviceFarmSelect').value || null;
                    
                    if (!deviceName) {
                        showModal('Warning', 'Device name is required', 'warning');
                        return;
                    }
                    if (!deviceIP) {
                        showModal('Warning', 'IP address is required', 'warning');
                        return;
                    }
                    
                    const payload = {
                        id: selectedDevice.id,
                        device_name: deviceName,
                        device_code: deviceCode,
                        ip_address: deviceIP,
                        device_type: deviceType,
                        user_id: selectedUser.id,
                        farm_id: farmId
                    };
                    
                    const res = await fetch('../php/admin_devices.php', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const d = await res.json();
                    if (!d.success) throw new Error(d.message || 'Update failed');
                    
                    showModal('Success', 'Device updated successfully', 'success');
                    clearDevice();
                    loadDevicesByUser(selectedUser.id);
                    
                } catch (e) {
                    showModal('Error', e.message || 'Update failed', 'error');
                }
            });
            
            document.getElementById('btnDeleteDevice').addEventListener('click', async () => {
                try {
                    if (!selectedDevice || !selectedDevice.id) {
                        showModal('Warning', 'Select a device to delete', 'warning');
                        return;
                    }
                    
                    if (!confirm(`Are you sure you want to delete device "${selectedDevice.name}"?`)) {
                        return;
                    }
                    
                    const res = await fetch('../php/admin_devices.php', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: selectedDevice.id })
                    });
                    
                    const d = await res.json();
                    if (!d.success) throw new Error(d.message || 'Delete failed');
                    
                    showModal('Success', 'Device deleted successfully', 'success');
                    clearDevice();
                    if (selectedUser) {
                        loadDevicesByUser(selectedUser.id);
                    }
                    
                } catch (e) {
                    showModal('Error', e.message || 'Delete failed', 'error');
                }
            });
            
            document.getElementById('btnTestDropdowns').addEventListener('click', () => {
                console.log('Testing dropdowns...');
                console.log('User select element:', document.getElementById('deviceUserSelect'));
                console.log('Farm select element:', document.getElementById('deviceFarmSelect'));
                loadUsersForDeviceAssignment();
            });
            
            // Update device farm dropdown when farm selection changes
            const deviceFarmSelect = document.getElementById('deviceFarmSelect');
            farmSelect.addEventListener('change', () => {
                deviceFarmSelect.innerHTML = farmSelect.innerHTML;
                deviceFarmSelect.value = farmSelect.value;
            });
            
            // Initialize device assignment dropdowns
            console.log('About to initialize device assignment dropdowns...');
            loadUsersForDeviceAssignment();
            console.log('Device assignment dropdowns initialization completed');
        });
    </script>
</body>
</html>
